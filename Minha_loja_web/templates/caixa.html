{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1><i class="fas fa-cash-register me-2"></i>Ponto de Venda (PDV)</h1>
                <div>
                    <span class="badge bg-success fs-6 me-3">
                        <i class="fas fa-user me-1"></i> Atendente: {{ current_user.username }}
                    </span>
                    <button id="btn-nova-venda" class="btn btn-outline-secondary">
                        <i class="fas fa-receipt me-2"></i>Nova Venda
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Painel de Venda -->
        <div class="col-lg-8 mb-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Registro de Venda</h4>
                </div>
                <div class="card-body">
                    <!-- Busca de Produtos -->
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <label for="busca-produto" class="form-label">
                                <i class="fas fa-search me-1"></i>Buscar Produto (Nome ou C√≥digo de Barras)
                            </label>
                            <div class="input-group">
                                <input type="text" class="form-control form-control-lg" 
                                       id="busca-produto" 
                                       placeholder="Digite o nome ou c√≥digo e pressione Enter..." 
                                       autofocus>
                                <button class="btn btn-outline-primary" type="button" id="btn-scan">
                                    <i class="fas fa-barcode"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label for="cliente-venda" class="form-label">
                                <i class="fas fa-user me-1"></i>Cliente (Opcional)
                            </label>
                            <select class="form-select" id="cliente-venda">
                                <option value="">Selecionar Cliente</option>
                                {% for cliente in clientes %}
                                <option value="{{ cliente.id }}">{{ cliente.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Carrinho -->
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th width="40%">Produto</th>
                                    <th width="15%">Pre√ßo Unit.</th>
                                    <th width="15%">Quantidade</th>
                                    <th width="15%">Subtotal</th>
                                    <th width="15%">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="carrinho-itens">
                                <tr id="carrinho-vazio">
                                    <td colspan="5" class="text-center py-4">
                                        <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                                        <p class="text-muted">Carrinho vazio. Adicione produtos usando a busca acima.</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Resumo do Carrinho -->
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Itens no carrinho:</strong> 
                                <span id="total-itens">0</span> produto(s)
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <h3 class="text-success">
                                TOTAL: R$ <span id="valor-total">0.00</span>
                            </h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Painel de Pagamento -->
        <div class="col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0"><i class="fas fa-credit-card me-2"></i>Finaliza√ß√£o</h4>
                </div>
                <div class="card-body">
                    <!-- Forma de Pagamento -->
                    <div class="mb-4">
                        <label for="forma-pagamento" class="form-label">
                            <i class="fas fa-money-bill-wave me-1"></i>Forma de Pagamento
                        </label>
                        <select class="form-select" id="forma-pagamento">
                            <option value="dinheiro">üíµ Dinheiro</option>
                            <option value="cartao_debito">üí≥ Cart√£o de D√©bito</option>
                            <option value="cartao_credito">üí≥ Cart√£o de Cr√©dito</option>
                            <option value="pix">üì± PIX</option>
                            <option value="transferencia">üè¶ Transfer√™ncia</option>
                        </select>
                    </div>

                    <!-- Campos Din√¢micos de Pagamento -->
                    <div id="campos-pagamento">
                        <!-- Dinheiro -->
                        <div class="pagamento-campo" id="campo-dinheiro">
                            <div class="mb-3">
                                <label for="valor-pago" class="form-label">Valor Entregue (R$)</label>
                                <input type="number" class="form-control" id="valor-pago" 
                                       step="0.01" min="0" placeholder="0.00">
                            </div>
                            <div class="alert alert-warning">
                                <i class="fas fa-calculator me-2"></i>
                                <strong>Troco:</strong> R$ <span id="valor-troco">0.00</span>
                            </div>
                        </div>

                        <!-- Cart√£o/PIX/Transfer√™ncia -->
                        <div class="pagamento-campo d-none" id="campo-outros">
                            <div class="alert alert-info">
                                <i class="fas fa-check-circle me-2"></i>
                                Valor a receber: R$ <span id="valor-a-receber">0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Bot√£o Finalizar -->
                    <div class="d-grid gap-2 mt-4">
                        <button id="btn-finalizar-venda" class="btn btn-success btn-lg" disabled>
                            <i class="fas fa-check-circle me-2"></i>Finalizar Venda
                        </button>
                        <button id="btn-cancelar-venda" class="btn btn-outline-danger">
                            <i class="fas fa-times me-2"></i>Cancelar Venda
                        </button>
                    </div>

                    <!-- Resumo R√°pido -->
                    <div class="mt-4 p-3 bg-light rounded">
                        <h6><i class="fas fa-clock me-2"></i>Resumo da Venda</h6>
                        <small class="text-muted">
                            <div>Itens: <span id="resumo-itens">0</span></div>
                            <div>Total: R$ <span id="resumo-total">0.00</span></div>
                            <div>Pagamento: <span id="resumo-pagamento">-</span></div>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirma√ß√£o -->
<div class="modal fade" id="modalConfirmacao" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-check-circle me-2"></i>Venda Finalizada!</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <i class="fas fa-receipt fa-4x text-success mb-3"></i>
                <h4>Venda registrada com sucesso!</h4>
                <p class="mb-0">N√∫mero da venda: <strong id="numero-venda">#0000</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" id="btn-imprimir-recibo">
                    <i class="fas fa-print me-2"></i>Imprimir Recibo
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Vari√°veis globais
let carrinho = [];
let totalVenda = 0;

// Inicializa√ß√£o
document.addEventListener('DOMContentLoaded', function() {
    console.log("üîÑ Inicializando caixa...");
    inicializarCaixa();
});

function inicializarCaixa() {
    console.log("üéØ Configurando eventos do caixa...");
    
    // Configurar busca de produtos
    const buscaInput = document.getElementById('busca-produto');
    buscaInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            const termo = this.value.trim();
            console.log("üîç Buscando produto:", termo);
            if (termo) {
                buscarEAdicionarProduto(termo);
                this.value = ''; // Limpar campo ap√≥s busca
            } else {
                mostrarNotificacao('Digite algo para buscar!', 'warning');
            }
        }
    });

    // Bot√£o de busca manual
    const btnBuscar = document.getElementById('btn-scan');
    if (btnBuscar) {
        btnBuscar.addEventListener('click', function() {
            const termo = buscaInput.value.trim();
            if (termo) {
                buscarEAdicionarProduto(termo);
                buscaInput.value = '';
            }
        });
    }

    // Configurar forma de pagamento
    const formaPagamento = document.getElementById('forma-pagamento');
    formaPagamento.addEventListener('change', atualizarCamposPagamento);

    // Configurar valor pago
    const valorPago = document.getElementById('valor-pago');
    if (valorPago) {
        valorPago.addEventListener('input', calcularTroco);
    }

    // Bot√µes
    document.getElementById('btn-finalizar-venda').addEventListener('click', finalizarVenda);
    document.getElementById('btn-cancelar-venda').addEventListener('click', cancelarVenda);
    document.getElementById('btn-nova-venda').addEventListener('click', novaVenda);

    // Inicializar campos de pagamento
    atualizarCamposPagamento();
    
    console.log("‚úÖ Caixa inicializado com sucesso!");
}

function buscarEAdicionarProduto(termo) {
    if (!termo || termo.trim().length < 1) {
        mostrarNotificacao('Digite um c√≥digo ou nome do produto!', 'warning');
        return;
    }

    console.log("üîç Iniciando busca por:", termo);
    
    // Mostrar loading
    const buscaInput = document.getElementById('busca-produto');
    buscaInput.disabled = true;
    buscaInput.placeholder = 'Buscando...';
    
    // Fazer a requisi√ß√£o
    fetch(`/api/buscar_produto/${encodeURIComponent(termo)}`)
        .then(response => {
            console.log("üì° Resposta recebida, status:", response.status);
            
            if (!response.ok) {
                throw new Error(`Erro HTTP: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log("üì¶ Dados recebidos:", data);
            
            // Verificar se √© um erro
            if (data.erro) {
                mostrarNotificacao(`‚ùå ${data.erro}`, 'danger');
                return;
            }

            // Verificar se produto tem estoque
            if (data.quantidade <= 0) {
                mostrarNotificacao(`üì¶ "${data.nome}" est√° sem estoque!`, 'danger');
                return;
            }

            // Verificar se produto j√° est√° no carrinho
            const itemExistente = carrinho.find(item => item.id === data.id);
            
            if (itemExistente) {
                // Verificar se pode aumentar quantidade
                if (itemExistente.quantidade >= data.quantidade) {
                    mostrarNotificacao(`‚ö†Ô∏è Estoque insuficiente! Dispon√≠vel: ${data.quantidade}`, 'warning');
                    return;
                }
                
                itemExistente.quantidade += 1;
                mostrarNotificacao(`‚ûï Quantidade de ${data.nome} aumentada!`, 'info');
            } else {
                // Adicionar novo item
                carrinho.push({
                    id: data.id,
                    nome: data.nome,
                    preco: parseFloat(data.preco),
                    quantidade: 1,
                    estoque: parseInt(data.quantidade)
                });
                mostrarNotificacao(`‚úÖ ${data.nome} adicionado ao carrinho! R$ ${data.preco}`, 'success');
            }

            atualizarCarrinho();
        })
        .catch(error => {
            console.error('‚ùå Erro na busca:', error);
            mostrarNotificacao('‚ùå Erro ao buscar produto! Verifique o console.', 'danger');
        })
        .finally(() => {
            // Restaurar campo de busca
            buscaInput.disabled = false;
            buscaInput.placeholder = 'Digite o c√≥digo ou nome e pressione Enter...';
            buscaInput.focus();
            console.log("üîÑ Busca finalizada");
        });
}

function atualizarCarrinho() {
    console.log("üõí Atualizando carrinho...");
    
    const tbody = document.getElementById('carrinho-itens');
    const carrinhoVazio = document.getElementById('carrinho-vazio');
    const totalElement = document.getElementById('valor-total');
    const totalItensElement = document.getElementById('total-itens');
    const btnFinalizar = document.getElementById('btn-finalizar-venda');

    // Calcular total
    totalVenda = carrinho.reduce((total, item) => total + (item.preco * item.quantidade), 0);
    console.log("üí∞ Total da venda:", totalVenda);

    // Atualizar UI
    if (carrinho.length === 0) {
        carrinhoVazio.style.display = '';
        tbody.innerHTML = '<tr id="carrinho-vazio"><td colspan="5" class="text-center py-4"><i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i><p class="text-muted">Carrinho vazio</p></td></tr>';
        btnFinalizar.disabled = true;
    } else {
        carrinhoVazio.style.display = 'none';
        
        tbody.innerHTML = carrinho.map((item, index) => `
            <tr>
                <td>
                    <strong>${item.nome}</strong>
                    ${item.quantidade > item.estoque ? '<span class="badge bg-danger ms-2">Estoque insuficiente</span>' : ''}
                </td>
                <td>R$ ${item.preco.toFixed(2)}</td>
                <td>
                    <div class="input-group input-group-sm">
                        <button class="btn btn-outline-secondary" onclick="alterarQuantidade(${index}, -1)">-</button>
                        <input type="number" class="form-control text-center" value="${item.quantidade}" 
                               onchange="alterarQuantidadeInput(${index}, this.value)" min="1" max="${item.estoque}">
                        <button class="btn btn-outline-secondary" onclick="alterarQuantidade(${index}, 1)">+</button>
                    </div>
                </td>
                <td class="fw-bold">R$ ${(item.preco * item.quantidade).toFixed(2)}</td>
                <td>
                    <button class="btn btn-sm btn-outline-danger" onclick="removerItem(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');

        btnFinalizar.disabled = carrinho.some(item => item.quantidade > item.estoque);
    }

    totalElement.textContent = totalVenda.toFixed(2);
    totalItensElement.textContent = carrinho.reduce((total, item) => total + item.quantidade, 0);

    // Atualizar resumo
    document.getElementById('resumo-itens').textContent = carrinho.reduce((total, item) => total + item.quantidade, 0);
    document.getElementById('resumo-total').textContent = totalVenda.toFixed(2);
    document.getElementById('valor-a-receber').textContent = totalVenda.toFixed(2);
    
    // Recalcular troco
    calcularTroco();
    
    console.log("‚úÖ Carrinho atualizado. Itens:", carrinho.length);
}

// Fun√ß√µes auxiliares (adicionar estas tamb√©m)
window.alterarQuantidade = function(index, cambio) {
    const novoValor = carrinho[index].quantidade + cambio;
    if (novoValor >= 1 && novoValor <= carrinho[index].estoque) {
        carrinho[index].quantidade = novoValor;
        atualizarCarrinho();
    }
}

window.alterarQuantidadeInput = function(index, valor) {
    const novoValor = parseInt(valor) || 1;
    if (novoValor >= 1 && novoValor <= carrinho[index].estoque) {
        carrinho[index].quantidade = novoValor;
        atualizarCarrinho();
    } else {
        // Restaurar valor anterior
        const input = document.querySelector(`#carrinho-itens tr:nth-child(${index + 1}) input`);
        input.value = carrinho[index].quantidade;
    }
}

window.removerItem = function(index) {
    const produtoNome = carrinho[index].nome;
    carrinho.splice(index, 1);
    atualizarCarrinho();
    mostrarNotificacao(`üóëÔ∏è ${produtoNome} removido do carrinho`, 'info');
}

function calcularTroco() {
    const formaPagamento = document.getElementById('forma-pagamento').value;
    if (formaPagamento === 'dinheiro') {
        const valorPago = parseFloat(document.getElementById('valor-pago').value) || 0;
        const troco = valorPago - totalVenda;
        const trocoElement = document.getElementById('valor-troco');
        
        if (trocoElement) {
            trocoElement.textContent = troco >= 0 ? troco.toFixed(2) : '0.00';
        }
    }
}

function mostrarNotificacao(mensagem, tipo) {
    const alerta = document.createElement('div');
    alerta.className = `alert alert-${type} alert-dismissible fade show`;
    alerta.innerHTML = `
        ${mensagem}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.querySelector('.container-fluid').prepend(alerta);
    
    setTimeout(() => alerta.remove(), 4000);
}

// ... (outras fun√ß√µes do caixa)

document.addEventListener('DOMContentLoaded', function() {
    const buscaInput = document.getElementById('busca-produto');
    
    buscaInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            const termo = this.value.trim();
            if (termo) {
                buscarEAdicionarProduto(termo);
                this.value = ''; // Limpar campo ap√≥s busca
            }
        }
    });
});

// Adicionar esta fun√ß√£o auxiliar no caixa.html
function mostrarLoadingBusca(mostrar) {
    const buscaInput = document.getElementById('busca-produto');
    const btnScan = document.getElementById('btn-scan');
    
    if (mostrar) {
        buscaInput.placeholder = 'Buscando produto...';
        buscaInput.disabled = true;
        btnScan.disabled = true;
    } else {
        buscaInput.placeholder = 'Digite o c√≥digo ou nome e pressione Enter...';
        buscaInput.disabled = false;
        btnScan.disabled = false;
    }
}

// Atualizar a fun√ß√£o buscarEAdicionarProduto:
function buscarEAdicionarProduto(termo) {
    if (!termo.trim()) {
        mostrarNotificacao('Digite um c√≥digo ou nome do produto!', 'warning');
        return;
    }

    mostrarLoadingBusca(true);
    
    fetch(`/api/buscar_produto/${encodeURIComponent(termo)}`)
        .then(response => {
            mostrarLoadingBusca(false);
            // ... resto do c√≥digo igual acima
        })
        .catch(error => {
            mostrarLoadingBusca(false);
            // ... tratamento de erro
        });
}
</script>
{% endblock %}