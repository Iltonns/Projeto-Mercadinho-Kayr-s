{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1><i class="fas fa-cash-register me-2"></i>Ponto de Venda (PDV)</h1>
                <div>
                    <span class="badge bg-success fs-6 me-3">
                        <i class="fas fa-user me-1"></i> Atendente: {{ current_user.username }}
                    </span>
                    <button id="btn-nova-venda" class="btn btn-outline-secondary">
                        <i class="fas fa-receipt me-2"></i>Nova Venda
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Painel de Venda -->
        <div class="col-lg-8 mb-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Registro de Venda</h4>
                </div>
                <div class="card-body">
                    <!-- Busca de Produtos -->
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <label for="busca-produto" class="form-label">
                                <i class="fas fa-search me-1"></i>Buscar Produto (Nome ou C√≥digo de Barras)
                            </label>
                            <div class="input-group">
                                <input type="text" class="form-control form-control-lg" 
                                       id="busca-produto" 
                                       placeholder="Digite o nome ou c√≥digo e pressione Enter..." 
                                       autofocus>
                                <button class="btn btn-outline-primary" type="button" id="btn-scan">
                                    <i class="fas fa-barcode"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label for="cliente-venda" class="form-label">
                                <i class="fas fa-user me-1"></i>Cliente (Opcional)
                            </label>
                            <select class="form-select" id="cliente-venda">
                                <option value="">Selecionar Cliente</option>
                                {% for cliente in clientes %}
                                <option value="{{ cliente.id }}">{{ cliente.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Carrinho -->
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th width="40%">Produto</th>
                                    <th width="15%">Pre√ßo Unit.</th>
                                    <th width="15%">Quantidade</th>
                                    <th width="15%">Subtotal</th>
                                    <th width="15%">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="carrinho-itens">
                                <tr id="carrinho-vazio">
                                    <td colspan="5" class="text-center py-4">
                                        <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                                        <p class="text-muted">Carrinho vazio. Adicione produtos usando a busca acima.</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Resumo do Carrinho -->
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Itens no carrinho:</strong> 
                                <span id="total-itens">0</span> produto(s)
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <h3 class="text-success">
                                TOTAL: R$ <span id="valor-total">0.00</span>
                            </h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Painel de Pagamento -->
        <div class="col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0"><i class="fas fa-credit-card me-2"></i>Finaliza√ß√£o</h4>
                </div>
                <div class="card-body">
                    <!-- Forma de Pagamento -->
                    <div class="mb-4">
                        <label for="forma-pagamento" class="form-label">
                            <i class="fas fa-money-bill-wave me-1"></i>Forma de Pagamento
                        </label>
                        <select class="form-select" id="forma-pagamento">
                            <option value="dinheiro">üíµ Dinheiro</option>
                            <option value="cartao_debito">üí≥ Cart√£o de D√©bito</option>
                            <option value="cartao_credito">üí≥ Cart√£o de Cr√©dito</option>
                            <option value="pix">üì± PIX</option>
                            <option value="transferencia">üè¶ Transfer√™ncia</option>
                        </select>
                    </div>

                    <!-- Campos Din√¢micos de Pagamento -->
                    <div id="campos-pagamento">
                        <!-- Dinheiro -->
                        <div class="pagamento-campo" id="campo-dinheiro">
                            <div class="mb-3">
                                <label for="valor-pago" class="form-label">Valor Entregue (R$)</label>
                                <input type="number" class="form-control" id="valor-pago" 
                                       step="0.01" min="0" placeholder="0.00">
                            </div>
                            <div class="alert alert-warning">
                                <i class="fas fa-calculator me-2"></i>
                                <strong>Troco:</strong> R$ <span id="valor-troco">0.00</span>
                            </div>
                        </div>

                        <!-- Cart√£o/PIX/Transfer√™ncia -->
                        <div class="pagamento-campo d-none" id="campo-outros">
                            <div class="alert alert-info">
                                <i class="fas fa-check-circle me-2"></i>
                                Valor a receber: R$ <span id="valor-a-receber">0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Bot√£o Finalizar -->
                    <div class="d-grid gap-2 mt-4">
                        <button id="btn-finalizar-venda" class="btn btn-success btn-lg" disabled>
                            <i class="fas fa-check-circle me-2"></i>Finalizar Venda
                        </button>
                        <button id="btn-cancelar-venda" class="btn btn-outline-danger">
                            <i class="fas fa-times me-2"></i>Cancelar Venda
                        </button>
                    </div>

                    <!-- Resumo R√°pido -->
                    <div class="mt-4 p-3 bg-light rounded">
                        <h6><i class="fas fa-clock me-2"></i>Resumo da Venda</h6>
                        <small class="text-muted">
                            <div>Itens: <span id="resumo-itens">0</span></div>
                            <div>Total: R$ <span id="resumo-total">0.00</span></div>
                            <div>Pagamento: <span id="resumo-pagamento">-</span></div>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirma√ß√£o -->
<div class="modal fade" id="modalConfirmacao" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-check-circle me-2"></i>Venda Finalizada!</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <i class="fas fa-receipt fa-4x text-success mb-3"></i>
                <h4>Venda registrada com sucesso!</h4>
                <p class="mb-0">N√∫mero da venda: <strong id="numero-venda">#0000</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" id="btn-imprimir-recibo">
                    <i class="fas fa-print me-2"></i>Imprimir Recibo
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    <script>
    // Vari√°veis globais
    let carrinho = [];
    let totalVenda = 0;
    
    // Inicializa√ß√£o
    document.addEventListener('DOMContentLoaded', function() {
        inicializarCaixa();
    });
    
    function inicializarCaixa() {
        // Configurar busca de produtos
        const buscaInput = document.getElementById('busca-produto');
        buscaInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                buscarEAdicionarProduto(this.value);
                this.value = '';
            }
        });
    
        // ... (resto dos seus event listeners que n√£o mudam)
        const formaPagamento = document.getElementById('forma-pagamento');
        formaPagamento.addEventListener('change', atualizarCamposPagamento);
        const valorPago = document.getElementById('valor-pago');
        valorPago.addEventListener('input', calcularTroco);
        document.getElementById('btn-finalizar-venda').addEventListener('click', finalizarVenda);
        document.getElementById('btn-cancelar-venda').addEventListener('click', cancelarVenda);
        document.getElementById('btn-nova-venda').addEventListener('click', novaVenda);
        atualizarCamposPagamento();
    }
    
    function buscarEAdicionarProduto(termo) {
        if (!termo.trim()) return;
    
        // APLICA√á√ÉO DA CORRE√á√ÉO 1
        fetch(`/api/buscar_produto/${encodeURIComponent(termo)}`, { credentials: 'same-origin' })
            .then(response => {
                if (!response.ok) { // Adiciona verifica√ß√£o de erro de rede
                    throw new Error(`Erro de rede: ${response.status}`);
                }
                return response.json();
            })
            .then(produto => {
                if (produto.erro) {
                    mostrarNotificacao('Produto n√£o encontrado!', 'danger');
                    return;
                }
    
                const itemExistente = carrinho.find(item => item.id === produto.id);
                
                if (itemExistente) {
                    itemExistente.quantidade += 1;
                    mostrarNotificacao(`Quantidade de ${produto.nome} aumentada!`, 'info');
                } else {
                    carrinho.push({
                        id: produto.id,
                        nome: produto.nome,
                        preco: produto.preco,
                        quantidade: 1,
                        estoque: produto.quantidade
                    });
                    mostrarNotificacao(`${produto.nome} adicionado ao carrinho!`, 'success');
                }
    
                atualizarCarrinho();
            })
            .catch(error => {
                console.error('Erro ao buscar produto:', error);
                mostrarNotificacao('Erro de comunica√ß√£o ao buscar produto!', 'danger');
            });
    }
    
    // ... (A fun√ß√£o atualizarCarrinho e outras fun√ß√µes auxiliares n√£o precisam de altera√ß√£o)
    function atualizarCarrinho() {
        const tbody = document.getElementById('carrinho-itens');
        const carrinhoVazio = document.getElementById('carrinho-vazio');
        const totalElement = document.getElementById('valor-total');
        const totalItensElement = document.getElementById('total-itens');
        const btnFinalizar = document.getElementById('btn-finalizar-venda');
    
        totalVenda = carrinho.reduce((total, item) => total + (item.preco * item.quantidade), 0);
    
        if (carrinho.length === 0) {
            tbody.innerHTML = '<tr id="carrinho-vazio"><td colspan="5" class="text-center py-4"><i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i><p class="text-muted">Carrinho vazio</p></td></tr>';
            btnFinalizar.disabled = true;
        } else {
            tbody.innerHTML = carrinho.map((item, index) => `
                <tr>
                    <td>
                        <strong>${item.nome}</strong>
                        ${item.quantidade > item.estoque ? '<span class="badge bg-danger ms-2">Estoque insuficiente</span>' : ''}
                    </td>
                    <td>R$ ${item.preco.toFixed(2)}</td>
                    <td>
                        <div class="input-group input-group-sm">
                            <button class="btn btn-outline-secondary" onclick="alterarQuantidade(${index}, -1)">-</button>
                            <input type="number" class="form-control text-center" value="${item.quantidade}" 
                                   onchange="alterarQuantidadeInput(${index}, this.value)" min="1" max="${item.estoque}">
                            <button class="btn btn-outline-secondary" onclick="alterarQuantidade(${index}, 1)">+</button>
                        </div>
                    </td>
                    <td class="fw-bold">R$ ${(item.preco * item.quantidade).toFixed(2)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="removerItem(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            btnFinalizar.disabled = carrinho.some(item => item.quantidade > item.estoque);
        }
    
        totalElement.textContent = totalVenda.toFixed(2);
        totalItensElement.textContent = carrinho.reduce((total, item) => total + item.quantidade, 0);
        document.getElementById('resumo-itens').textContent = carrinho.reduce((total, item) => total + item.quantidade, 0);
        document.getElementById('resumo-total').textContent = totalVenda.toFixed(2);
        document.getElementById('valor-a-receber').textContent = totalVenda.toFixed(2);
        calcularTroco();
    }
    
    function finalizarVenda() {
        const formaPagamento = document.getElementById('forma-pagamento').value;
        const clienteId = document.getElementById('cliente-venda').value || null;
        const valorPago = parseFloat(document.getElementById('valor-pago').value) || totalVenda;
    
        const dadosVenda = {
            itens: carrinho,
            cliente_id: clienteId,
            forma_pagamento: formaPagamento,
            valor_pago: valorPago,
            troco: formaPagamento === 'dinheiro' ? (valorPago - totalVenda) : 0
        };
    
        // APLICA√á√ÉO DA CORRE√á√ÉO 2
        fetch('/caixa/finalizar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(dadosVenda),
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.erro) {
                mostrarNotificacao(data.erro, 'danger');
            } else {
                document.getElementById('numero-venda').textContent = '#' + data.venda_id;
                new bootstrap.Modal(document.getElementById('modalConfirmacao')).show();
                novaVenda(); // Assumindo que esta fun√ß√£o limpa o caixa para uma nova venda
            }
        })
        .catch(error => {
            console.error('Erro ao finalizar venda:', error);
            mostrarNotificacao('Erro ao finalizar venda!', 'danger');
        });
    }
    
    // Implemente as outras fun√ß√µes (novaVenda, cancelarVenda, alterarQuantidade, etc.) aqui
    // ...
    function mostrarNotificacao(mensagem, tipo) {
        const container = document.querySelector('.container-fluid');
        if (!container) return;
    
        const alerta = document.createElement('div');
        // CORRE√á√ÉO: Usando a vari√°vel 'tipo' que foi recebida pela fun√ß√£o
        alerta.className = `alert alert-${tipo} alert-dismissible fade show`; 
        alerta.style.position = 'fixed';
        alerta.style.top = '20px';
        alerta.style.right = '20px';
        alerta.style.zIndex = '1050'; // Garante que a notifica√ß√£o apare√ßa sobre outros elementos
        alerta.innerHTML = `
            ${mensagem}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        // Adiciona o alerta no in√≠cio do container para ele aparecer no topo
        document.body.appendChild(alerta);
        
        // Garante que a notifica√ß√£o possa ser fechada e removida
        const bsAlert = new bootstrap.Alert(alerta);
        setTimeout(() => {
            bsAlert.close();
        }, 3000);
    }
    }
    
    // Fun√ß√µes que faltavam (vers√µes simples para garantir que n√£o d√™ erro)
    function alterarQuantidade(index, delta) {
        if (carrinho[index]) {
            let novaQtd = carrinho[index].quantidade + delta;
            if (novaQtd < 1) {
                removerItem(index);
            } else if (novaQtd > carrinho[index].estoque) {
                mostrarNotificacao('Quantidade excede o estoque dispon√≠vel!', 'warning');
            } else {
                carrinho[index].quantidade = novaQtd;
                atualizarCarrinho();
            }
        }
    }
    function alterarQuantidadeInput(index, valor) {
        if (carrinho[index]) {
            let novaQtd = parseInt(valor, 10);
            if (isNaN(novaQtd) || novaQtd < 1) {
                novaQtd = 1;
            }
            if (novaQtd > carrinho[index].estoque) {
                novaQtd = carrinho[index].estoque;
                mostrarNotificacao('Quantidade excede o estoque dispon√≠vel!', 'warning');
            }
            carrinho[index].quantidade = novaQtd;
            atualizarCarrinho();
        }
    }
    function removerItem(index) {
        carrinho.splice(index, 1);
        atualizarCarrinho();
    }
    function novaVenda() {
        carrinho = [];
        totalVenda = 0;
        document.getElementById('cliente-venda').value = '';
        document.getElementById('forma-pagamento').value = 'dinheiro';
        document.getElementById('valor-pago').value = '';
        atualizarCamposPagamento();
        atualizarCarrinho();
    }
    function cancelarVenda() {
        if (confirm('Tem certeza que deseja cancelar a venda atual?')) {
            novaVenda();
            mostrarNotificacao('Venda cancelada.', 'info');
        }
    }
    function atualizarCamposPagamento() {
        const forma = document.getElementById('forma-pagamento').value;
        document.getElementById('campo-dinheiro').classList.toggle('d-none', forma !== 'dinheiro');
        document.getElementById('campo-outros').classList.toggle('d-none', forma === 'dinheiro');
    }
    function calcularTroco() {
        const valorPago = parseFloat(document.getElementById('valor-pago').value) || 0;
        const troco = valorPago - totalVenda;
        document.getElementById('valor-troco').textContent = troco > 0 ? troco.toFixed(2) : '0.00';
    }
    </script>
    {% endblock %}