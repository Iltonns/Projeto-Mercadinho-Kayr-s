{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1><i class="fas fa-cash-register me-2"></i>Ponto de Venda (PDV)</h1>
                <div>
                    <span class="badge bg-success fs-6 me-3">
                        <i class="fas fa-user me-1"></i> Atendente: {{ current_user.username }}
                    </span>
                    <button id="btn-nova-venda" class="btn btn-outline-secondary">
                        <i class="fas fa-receipt me-2"></i>Nova Venda
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Painel de Venda -->
        <div class="col-lg-8 mb-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Registro de Venda</h4>
                </div>
                <div class="card-body">
                    <!-- Busca de Produtos -->
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <label for="busca-produto" class="form-label">
                                <i class="fas fa-search me-1"></i>Buscar Produto (Nome ou C√≥digo de Barras)
                            </label>
                            <div class="input-group">
                                <input type="text" class="form-control form-control-lg" 
                                       id="busca-produto" 
                                       placeholder="Digite o nome ou c√≥digo e pressione Enter..." 
                                       autofocus>
                                <button class="btn btn-outline-primary" type="button" id="btn-buscar">
                                    <i class="fas fa-search"></i> Buscar
                                </button>
                            </div>
                            <div id="resultado-busca" class="mt-2"></div>
                        </div>
                        <div class="col-md-4">
                            <label for="cliente-venda" class="form-label">
                                <i class="fas fa-user me-1"></i>Cliente (Opcional)
                            </label>
                            <select class="form-select" id="cliente-venda">
                                <option value="">Selecionar Cliente</option>
                                {% for cliente in clientes %}
                                <option value="{{ cliente.id }}">{{ cliente.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Carrinho -->
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th width="40%">Produto</th>
                                    <th width="15%">Pre√ßo Unit.</th>
                                    <th width="15%">Quantidade</th>
                                    <th width="15%">Subtotal</th>
                                    <th width="15%">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="carrinho-itens">
                                <tr id="carrinho-vazio">
                                    <td colspan="5" class="text-center py-4">
                                        <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                                        <p class="text-muted">Carrinho vazio. Adicione produtos usando a busca acima.</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Resumo do Carrinho -->
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Itens no carrinho:</strong> 
                                <span id="total-itens">0</span> produto(s)
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <h3 class="text-success">
                                TOTAL: R$ <span id="valor-total">0.00</span>
                            </h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Painel de Pagamento -->
        <div class="col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0"><i class="fas fa-credit-card me-2"></i>Finaliza√ß√£o</h4>
                </div>
                <div class="card-body">
                    <!-- Forma de Pagamento -->
                    <div class="mb-4">
                        <label for="forma-pagamento" class="form-label">
                            <i class="fas fa-money-bill-wave me-1"></i>Forma de Pagamento
                        </label>
                        <select class="form-select" id="forma-pagamento">
                            <option value="Dinheiro">üíµ Dinheiro</option>
                            <option value="Cart√£o D√©bito">üí≥ Cart√£o de D√©bito</option>
                            <option value="Cart√£o Cr√©dito">üí≥ Cart√£o de Cr√©dito</option>
                            <option value="PIX">üì± PIX</option>
                            <option value="Transfer√™ncia">üè¶ Transfer√™ncia</option>
                        </select>
                    </div>

                    <!-- Campos Din√¢micos de Pagamento -->
                    <div id="campos-pagamento">
                        <!-- Dinheiro -->
                        <div class="pagamento-campo" id="campo-dinheiro">
                            <div class="mb-3">
                                <label for="valor-pago" class="form-label">Valor Entregue (R$)</label>
                                <input type="number" class="form-control" id="valor-pago" 
                                       step="0.01" min="0" placeholder="0.00">
                            </div>
                            <div class="alert alert-warning">
                                <i class="fas fa-calculator me-2"></i>
                                <strong>Troco:</strong> R$ <span id="valor-troco">0.00</span>
                            </div>
                        </div>

                        <!-- Cart√£o/PIX/Transfer√™ncia -->
                        <div class="pagamento-campo d-none" id="campo-outros">
                            <div class="alert alert-info">
                                <i class="fas fa-check-circle me-2"></i>
                                Valor a receber: R$ <span id="valor-a-receber">0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Bot√£o Finalizar -->
                    <div class="d-grid gap-2 mt-4">
                        <button id="btn-finalizar-venda" class="btn btn-success btn-lg" disabled>
                            <i class="fas fa-check-circle me-2"></i>Finalizar Venda
                        </button>
                        <button id="btn-cancelar-venda" class="btn btn-outline-danger">
                            <i class="fas fa-times me-2"></i>Cancelar Venda
                        </button>
                    </div>

                    <!-- Resumo R√°pido -->
                    <div class="mt-4 p-3 bg-light rounded">
                        <h6><i class="fas fa-clock me-2"></i>Resumo da Venda</h6>
                        <small class="text-muted">
                            <div>Itens: <span id="resumo-itens">0</span></div>
                            <div>Total: R$ <span id="resumo-total">0.00</span></div>
                            <div>Pagamento: <span id="resumo-pagamento">-</span></div>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirma√ß√£o -->
<div class="modal fade" id="modalConfirmacao" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-check-circle me-2"></i>Venda Finalizada!</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <i class="fas fa-receipt fa-4x text-success mb-3"></i>
                <h4>Venda registrada com sucesso!</h4>
                <p class="mb-0">N√∫mero da venda: <strong id="numero-venda">#0000</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" id="btn-imprimir-recibo">
                    <i class="fas fa-print me-2"></i>Imprimir Recibo
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Vari√°veis globais
let carrinho = [];
let totalVenda = 0;

// Inicializa√ß√£o
document.addEventListener('DOMContentLoaded', function() {
    inicializarCaixa();
});

function inicializarCaixa() {
    // Configurar busca de produtos - CORRE√á√ÉO 1: Busca via POST
    const buscaInput = document.getElementById('busca-produto');
    const btnBuscar = document.getElementById('btn-buscar');
    
    buscaInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            buscarEAdicionarProduto(this.value);
        }
    });
    
    btnBuscar.addEventListener('click', function() {
        buscarEAdicionarProduto(buscaInput.value);
    });

    // Event listeners para pagamento
    const formaPagamento = document.getElementById('forma-pagamento');
    formaPagamento.addEventListener('change', atualizarCamposPagamento);
    
    const valorPago = document.getElementById('valor-pago');
    valorPago.addEventListener('input', calcularTroco);
    
    document.getElementById('btn-finalizar-venda').addEventListener('click', finalizarVenda);
    document.getElementById('btn-cancelar-venda').addEventListener('click', cancelarVenda);
    document.getElementById('btn-nova-venda').addEventListener('click', novaVenda);
    
    atualizarCamposPagamento();
}

// CORRE√á√ÉO 1: Busca de produtos via POST (nova rota)
function buscarEAdicionarProduto(termo) {
    if (!termo.trim()) {
        mostrarNotificacao('Digite um c√≥digo ou nome do produto', 'warning');
        return;
    }

    // Usando a nova rota POST corrigida
    fetch('/buscar_produto_caixa', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ codigo: termo })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Erro na busca');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            const produto = data.produto;
            adicionarProdutoAoCarrinho(produto);
        } else {
            mostrarNotificacao(data.message || 'Produto n√£o encontrado', 'danger');
            document.getElementById('resultado-busca').innerHTML = 
                `<div class="alert alert-warning">${data.message}</div>`;
        }
    })
    .catch(error => {
        console.error('Erro ao buscar produto:', error);
        mostrarNotificacao('Erro de comunica√ß√£o com o servidor', 'danger');
    });
}

function adicionarProdutoAoCarrinho(produto) {
    const itemExistente = carrinho.find(item => item.id === produto.id);
    
    if (itemExistente) {
        // Verificar se pode aumentar a quantidade
        if (itemExistente.quantidade < produto.quantidade) {
            itemExistente.quantidade += 1;
            mostrarNotificacao(`Quantidade de ${produto.nome} aumentada!`, 'info');
        } else {
            mostrarNotificacao(`Estoque insuficiente para ${produto.nome}!`, 'warning');
            return;
        }
    } else {
        // Verificar se h√° estoque dispon√≠vel
        if (produto.quantidade > 0) {
            carrinho.push({
                id: produto.id,
                nome: produto.nome,
                preco: parseFloat(produto.preco),
                quantidade: 1,
                estoque: parseInt(produto.quantidade)
            });
            mostrarNotificacao(`${produto.nome} adicionado ao carrinho!`, 'success');
        } else {
            mostrarNotificacao(`${produto.nome} sem estoque dispon√≠vel!`, 'warning');
            return;
        }
    }

    // Limpar busca
    document.getElementById('busca-produto').value = '';
    document.getElementById('resultado-busca').innerHTML = '';
    
    atualizarCarrinho();
}

function atualizarCarrinho() {
    const tbody = document.getElementById('carrinho-itens');
    const carrinhoVazio = document.getElementById('carrinho-vazio');
    const totalElement = document.getElementById('valor-total');
    const totalItensElement = document.getElementById('total-itens');
    const btnFinalizar = document.getElementById('btn-finalizar-venda');

    totalVenda = carrinho.reduce((total, item) => total + (item.preco * item.quantidade), 0);

    if (carrinho.length === 0) {
        tbody.innerHTML = '<tr id="carrinho-vazio"><td colspan="5" class="text-center py-4"><i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i><p class="text-muted">Carrinho vazio</p></td></tr>';
        btnFinalizar.disabled = true;
    } else {
        tbody.innerHTML = carrinho.map((item, index) => `
            <tr>
                <td>
                    <strong>${item.nome}</strong>
                    ${item.quantidade > item.estoque ? '<span class="badge bg-danger ms-2">Estoque insuficiente</span>' : ''}
                </td>
                <td>R$ ${item.preco.toFixed(2)}</td>
                <td>
                    <div class="input-group input-group-sm">
                        <button class="btn btn-outline-secondary" onclick="alterarQuantidade(${index}, -1)">-</button>
                        <input type="number" class="form-control text-center" value="${item.quantidade}" 
                               onchange="alterarQuantidadeInput(${index}, this.value)" min="1" max="${item.estoque}">
                        <button class="btn btn-outline-secondary" onclick="alterarQuantidade(${index}, 1)">+</button>
                    </div>
                    <small class="text-muted">Estoque: ${item.estoque}</small>
                </td>
                <td class="fw-bold">R$ ${(item.preco * item.quantidade).toFixed(2)}</td>
                <td>
                    <button class="btn btn-sm btn-outline-danger" onclick="removerItem(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
        
        // Habilitar/desabilitar bot√£o finalizar baseado no estoque
        const temEstoqueInsuficiente = carrinho.some(item => item.quantidade > item.estoque);
        btnFinalizar.disabled = temEstoqueInsuficiente || carrinho.length === 0;
    }

    // Atualizar totais
    totalElement.textContent = totalVenda.toFixed(2);
    const totalItens = carrinho.reduce((total, item) => total + item.quantidade, 0);
    totalItensElement.textContent = totalItens;
    
    // Atualizar resumo
    document.getElementById('resumo-itens').textContent = totalItens;
    document.getElementById('resumo-total').textContent = totalVenda.toFixed(2);
    document.getElementById('resumo-pagamento').textContent = document.getElementById('forma-pagamento').options[document.getElementById('forma-pagamento').selectedIndex].text;
    document.getElementById('valor-a-receber').textContent = totalVenda.toFixed(2);
    
    calcularTroco();
}

// CORRE√á√ÉO 2: Finaliza√ß√£o de venda corrigida
function finalizarVenda() {
    if (carrinho.length === 0) {
        mostrarNotificacao('Carrinho vazio! Adicione produtos antes de finalizar.', 'warning');
        return;
    }

    // Verificar estoque novamente antes de finalizar
    const semEstoque = carrinho.some(item => item.quantidade > item.estoque);
    if (semEstoque) {
        mostrarNotificacao('Alguns produtos t√™m quantidade maior que o estoque!', 'danger');
        return;
    }

    const formaPagamento = document.getElementById('forma-pagamento').value;
    const clienteId = document.getElementById('cliente-venda').value || null;
    const valorPago = parseFloat(document.getElementById('valor-pago').value) || totalVenda;

    // Validar pagamento em dinheiro
    if (formaPagamento === 'Dinheiro' && valorPago < totalVenda) {
        mostrarNotificacao('Valor pago √© menor que o total da venda!', 'danger');
        return;
    }

    const dadosVenda = {
        itens: carrinho.map(item => ({
            id: item.id,
            qtd: item.quantidade
        })),
        cliente_id: clienteId,
        forma_pagamento: formaPagamento,
        valor_pago: valorPago,
        troco: formaPagamento === 'Dinheiro' ? (valorPago - totalVenda) : 0
    };

    fetch('/caixa/finalizar', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(dadosVenda)
    })
    .then(response => response.json())
    .then(data => {
        if (data.erro) {
            mostrarNotificacao(data.erro, 'danger');
        } else {
            document.getElementById('numero-venda').textContent = '#' + data.venda_id;
            
            // Mostrar modal de confirma√ß√£o
            const modal = new bootstrap.Modal(document.getElementById('modalConfirmacao'));
            modal.show();
            
            // Configurar bot√£o do modal
            document.getElementById('btn-imprimir-recibo').onclick = function() {
                imprimirRecibo(data.venda_id);
            };
        }
    })
    .catch(error => {
        console.error('Erro ao finalizar venda:', error);
        mostrarNotificacao('Erro ao finalizar venda! Tente novamente.', 'danger');
    });
}

function imprimirRecibo(vendaId) {
    // Redirecionar para p√°gina de recibo ou abrir em nova janela
    window.open(`/recibo/${vendaId}`, '_blank');
}

function mostrarNotificacao(mensagem, tipo) {
    // Remover notifica√ß√µes anteriores
    const notificacoesAntigas = document.querySelectorAll('.alert-notificacao');
    notificacoesAntigas.forEach(notif => notif.remove());

    const alerta = document.createElement('div');
    alerta.className = `alert alert-${tipo} alert-dismissible fade show alert-notificacao`;
    alerta.style.position = 'fixed';
    alerta.style.top = '20px';
    alerta.style.right = '20px';
    alerta.style.zIndex = '1050';
    alerta.style.minWidth = '300px';
    
    alerta.innerHTML = `
        <i class="fas fa-${tipo === 'success' ? 'check' : tipo === 'warning' ? 'exclamation-triangle' : 'exclamation-circle'} me-2"></i>
        ${mensagem}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alerta);
    
    // Auto-remover ap√≥s 5 segundos
    setTimeout(() => {
        if (alerta.parentNode) {
            alerta.remove();
        }
    }, 5000);
}

// Fun√ß√µes auxiliares
function alterarQuantidade(index, delta) {
    if (carrinho[index]) {
        let novaQtd = carrinho[index].quantidade + delta;
        if (novaQtd < 1) {
            removerItem(index);
        } else if (novaQtd > carrinho[index].estoque) {
            mostrarNotificacao('Quantidade excede o estoque dispon√≠vel!', 'warning');
        } else {
            carrinho[index].quantidade = novaQtd;
            atualizarCarrinho();
        }
    }
}

function alterarQuantidadeInput(index, valor) {
    if (carrinho[index]) {
        let novaQtd = parseInt(valor, 10);
        if (isNaN(novaQtd) || novaQtd < 1) {
            novaQtd = 1;
        }
        if (novaQtd > carrinho[index].estoque) {
            novaQtd = carrinho[index].estoque;
            mostrarNotificacao('Quantidade ajustada para o m√°ximo dispon√≠vel!', 'warning');
        }
        carrinho[index].quantidade = novaQtd;
        atualizarCarrinho();
    }
}

function removerItem(index) {
    const produtoNome = carrinho[index].nome;
    carrinho.splice(index, 1);
    mostrarNotificacao(`${produtoNome} removido do carrinho!`, 'info');
    atualizarCarrinho();
}

function novaVenda() {
    if (carrinho.length > 0 && !confirm('Tem certeza que deseja iniciar uma nova venda? O carrinho atual ser√° perdido.')) {
        return;
    }
    
    carrinho = [];
    totalVenda = 0;
    document.getElementById('cliente-venda').value = '';
    document.getElementById('forma-pagamento').value = 'Dinheiro';
    document.getElementById('valor-pago').value = '';
    document.getElementById('busca-produto').value = '';
    document.getElementById('resultado-busca').innerHTML = '';
    
    atualizarCamposPagamento();
    atualizarCarrinho();
    
    mostrarNotificacao('Nova venda iniciada!', 'success');
}

function cancelarVenda() {
    if (carrinho.length === 0) {
        mostrarNotificacao('N√£o h√° venda para cancelar!', 'info');
        return;
    }
    
    if (confirm('Tem certeza que deseja cancelar a venda atual?')) {
        novaVenda();
    }
}

function atualizarCamposPagamento() {
    const forma = document.getElementById('forma-pagamento').value;
    const isDinheiro = forma === 'Dinheiro';
    
    document.getElementById('campo-dinheiro').classList.toggle('d-none', !isDinheiro);
    document.getElementById('campo-outros').classList.toggle('d-none', isDinheiro);
    
    if (!isDinheiro) {
        document.getElementById('valor-pago').value = totalVenda.toFixed(2);
    }
    
    document.getElementById('resumo-pagamento').textContent = document.getElementById('forma-pagamento').options[document.getElementById('forma-pagamento').selectedIndex].text;
}

function calcularTroco() {
    const valorPago = parseFloat(document.getElementById('valor-pago').value) || 0;
    const troco = Math.max(0, valorPago - totalVenda);
    document.getElementById('valor-troco').textContent = troco.toFixed(2);
}
</script>
{% endblock %}