<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caixa - Sistema de Vendas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet">
    <style>
        .produto-card { cursor: pointer; transition: all 0.3s; border: 2px solid transparent; }
        .produto-card:hover { transform: translateY(-2px); border-color: #007bff; }
        .carrinho-item { border-bottom: 1px solid #eee; padding: 10px 0; }
        .quantidade-control { display: flex; align-items: center; gap: 5px; }
        .quantidade-btn { width: 30px; height: 30px; border: 1px solid #ddd; background: #f8f9fa; cursor: pointer; border-radius: 4px; }
        .quantidade-input { width: 60px; text-align: center; border: 1px solid #ddd; border-radius: 4px; }
        .estoque-baixo { color: #dc3545; font-weight: bold; }
        .autocomplete-suggestions { position: absolute; background: white; border: 1px solid #ccc; max-height: 200px; overflow-y: auto; z-index: 1000; width: 100%; }
        .autocomplete-suggestion { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .autocomplete-suggestion:hover { background-color: #f8f9fa; }
        .select2-container--default .select2-selection--single { height: 38px; padding: 5px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('dashboard') }}">
                <i class="fas fa-cash-register"></i> Caixa
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('dashboard') }}">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                <a class="nav-link" href="{{ url_for('logout') }}">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Coluna de Busca e Produtos -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-search"></i> Buscar Produtos</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Busca Rápida:</label>
                            <div class="input-group">
                                <input type="text" id="buscaRapida" class="form-control" placeholder="Digite o nome do produto...">
                                <button class="btn btn-outline-primary" onclick="buscarProdutos()"><i class="fas fa-search"></i></button>
                            </div>
                            <div id="suggestions" class="autocomplete-suggestions" style="display: none;"></div>
                        </div>

                        <div id="listaProdutos">
                            <h6>Produtos em Estoque:</h6>
                            <div class="row">
                                {% for produto in produtos %}
                                <div class="col-md-6 mb-3">
                                    <div class="card produto-card" onclick="adicionarAoCarrinho({{ produto.id }}, '{{ produto.nome | replace("'", "&#39;") }}', {{ produto.preco }}, {{ produto.quantidade }})">
                                        <div class="card-body">
                                            <h6 class="card-title">{{ produto.nome }}</h6>
                                            <p class="card-text mb-1"><small>Código: {{ produto.codigo_barras or 'N/A' }}</small></p>
                                            <p class="card-text mb-1">Preço: R$ {{ "%.2f"|format(produto.preco) }}</p>
                                            <p class="card-text {% if produto.quantidade <= 5 %}estoque-baixo{% endif %}">Estoque: {{ produto.quantidade }}</p>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Coluna do Carrinho -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-shopping-cart"></i> Carrinho de Venda</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Cliente (Opcional):</label>
                            <select id="clienteSelect" class="form-select">
                                <option value="">Selecionar Cliente</option>
                                {% for cliente in clientes %}
                                <option value="{{ cliente.id }}">{{ cliente.nome }} - {{ cliente.telefone or 'Sem telefone' }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div id="carrinhoVazio" class="text-center py-4">
                            <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                            <p class="text-muted">Carrinho vazio</p>
                        </div>
                        
                        <div id="carrinhoItens" style="display: none;">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Produto</th>
                                            <th>Qtd</th>
                                            <th>Preço Unit.</th>
                                            <th>Total</th>
                                            <th>Ação</th>
                                        </tr>
                                    </thead>
                                    <tbody id="carrinhoTbody"></tbody>
                                </table>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-md-6"><h5>Total: R$ <span id="totalCarrinho">0.00</span></h5></div>
                                <div class="col-md-6 text-end">
                                    <button class="btn btn-danger btn-sm" onclick="limparCarrinho()"><i class="fas fa-trash"></i> Limpar Carrinho</button>
                                </div>
                            </div>

                            <div class="mt-4">
                                <h6>Forma de Pagamento:</h6>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <select id="metodoPagamento" class="form-select" onchange="toggleTroco()">
                                            <option value="Dinheiro">Dinheiro</option>
                                            <option value="Cartão Débito">Cartão Débito</option>
                                            <option value="Cartão Crédito">Cartão Crédito</option>
                                            <option value="PIX">PIX</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6" id="divTroco" style="display: none;">
                                        <input type="number" id="valorPago" class="form-control" placeholder="Valor recebido" step="0.01" min="0" oninput="calcularTroco()">
                                        <small>Troco: R$ <span id="troco">0.00</span></small>
                                    </div>
                                </div>
                                
                                <div class="text-end">
                                    <button class="btn btn-success btn-lg" onclick="finalizarVenda()">
                                        <i class="fas fa-check"></i> Finalizar Venda
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação -->
    <div class="modal fade" id="confirmacaoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmacaoTitulo">Confirmação</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="confirmacaoCorpo"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnConfirmar">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <script>
        <script>
            let carrinho = [];
        
            $(document).ready(function() { $('#clienteSelect').select2(); });
        
            // Autocomplete
            document.getElementById('buscaRapida').addEventListener('input', function(e) {
                const termo = e.target.value.trim();
                if (termo.length >= 2) buscarAutocomplete(termo);
                else document.getElementById('suggestions').style.display = 'none';
            });
        
            function buscarAutocomplete(termo) {
                // Primeira correção: Adicionando 'credentials' para autenticar a busca
                fetch(`/api/autocomplete_produtos/${encodeURIComponent(termo)}`, { credentials: 'same-origin' }) // <-- CORREÇÃO 1 AQUI
                    .then(resp => {
                        if (!resp.ok) {
                            throw new Error(`Erro HTTP: ${resp.status}`);
                        }
                        return resp.json();
                    })
                    .then(produtos => {
                        const suggestions = document.getElementById('suggestions');
                        suggestions.innerHTML = '';
                        produtos.forEach(prod => {
                            const div = document.createElement('div');
                            div.className = 'autocomplete-suggestion';
                            div.innerHTML = `<strong>${prod.nome}</strong><br><small>R$ ${prod.preco.toFixed(2)} | Estoque: ${prod.quantidade} | Cód: ${prod.codigo_barras || 'N/A'}</small>`;
                            div.onclick = () => { adicionarAoCarrinho(prod.id, prod.nome, prod.preco, prod.quantidade); suggestions.style.display = 'none'; document.getElementById('buscaRapida').value = ''; };
                            suggestions.appendChild(div);
                        });
                        suggestions.style.display = produtos.length > 0 ? 'block' : 'none';
                    })
                    .catch(err => {
                        console.error('Erro no autocomplete:', err);
                        // Opcional: notificar o usuário sobre a falha na busca
                        // alert('Falha ao buscar produtos. Verifique o console.');
                    });
            }
        
            // Funções de carrinho (sem alterações aqui)
            function adicionarAoCarrinho(id, nome, preco, estoque) {
                const itemExistente = carrinho.find(item => item.id === id);
                if (itemExistente) { if (itemExistente.quantidade < estoque) itemExistente.quantidade++; else { alert('Estoque insuficiente!'); return; } }
                else { if (estoque > 0) carrinho.push({id, nome, preco, quantidade:1, estoque}); else { alert('Produto sem estoque!'); return; } }
                atualizarCarrinho(); document.getElementById('suggestions').style.display = 'none';
            }
        
            function atualizarCarrinho() {
                const tbody = document.getElementById('carrinhoTbody');
                const totalSpan = document.getElementById('totalCarrinho');
                const carrinhoVazio = document.getElementById('carrinhoVazio');
                const carrinhoItens = document.getElementById('carrinhoItens');
        
                tbody.innerHTML = '';
                let total = 0;
                if (carrinho.length === 0) { carrinhoVazio.style.display = 'block'; carrinhoItens.style.display = 'none'; return; }
                carrinhoVazio.style.display = 'none'; carrinhoItens.style.display = 'block';
        
                carrinho.forEach((item, index) => {
                    const subtotal = item.preco * item.quantidade; total += subtotal; item.subtotal = subtotal;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${item.nome}</td>
                        <td><div class="quantidade-control">
                            <button class="quantidade-btn" onclick="alterarQuantidade(${index}, -1)">-</button>
                            <input type="number" class="quantidade-input" value="${item.quantidade}" onchange="alterarQuantidadeInput(${index}, this.value)" min="1" max="${item.estoque}">
                            <button class="quantidade-btn" onclick="alterarQuantidade(${index}, 1)">+</button>
                        </div></td>
                        <td>R$ ${item.preco.toFixed(2)}</td>
                        <td>R$ ${subtotal.toFixed(2)}</td>
                        <td><button class="btn btn-sm btn-danger" onclick="removerDoCarrinho(${index})"><i class="fas fa-trash"></i></button></td>`;
                    tbody.appendChild(tr);
                });
                totalSpan.textContent = total.toFixed(2); calcularTroco();
            }
        
            function alterarQuantidade(index, delta) { const item = carrinho[index]; const novaQuantidade = item.quantidade + delta; if (novaQuantidade < 1) { removerDoCarrinho(index); return; } if (novaQuantidade > item.estoque) { alert('Quantidade superior ao estoque disponível!'); return; } item.quantidade = novaQuantidade; atualizarCarrinho(); }
            function alterarQuantidadeInput(index, valor) { const quantidade = parseInt(valor); const item = carrinho[index]; if (isNaN(quantidade) || quantidade < 1) item.quantidade = 1; else if (quantidade > item.estoque) { alert('Quantidade superior ao estoque disponível!'); item.quantidade = item.estoque; } else item.quantidade = quantidade; atualizarCarrinho(); }
            function removerDoCarrinho(index) { carrinho.splice(index, 1); atualizarCarrinho(); }
            function limparCarrinho() { if (carrinho.length>0 && confirm('Deseja limpar o carrinho?')) { carrinho=[]; atualizarCarrinho(); } }
        
            // Pagamento (sem alterações aqui)
            function toggleTroco() { const metodo = document.getElementById('metodoPagamento').value; const divTroco = document.getElementById('divTroco'); if (metodo==='Dinheiro') { divTroco.style.display='block'; document.getElementById('valorPago').value=''; document.getElementById('troco').textContent='0.00'; } else { divTroco.style.display='none'; document.getElementById('valorPago').value=''; document.getElementById('troco').textContent='0.00'; } }
            function calcularTroco() { const total=parseFloat(document.getElementById('totalCarrinho').textContent)||0; const valorPago=parseFloat(document.getElementById('valorPago').value)||0; document.getElementById('troco').textContent=Math.max(0,valorPago-total).toFixed(2); }
        
            // Finalizar venda
            function finalizarVenda() {
                if (carrinho.length===0){alert('Carrinho vazio!');return;}
                const clienteSelect=document.getElementById('clienteSelect');
                const metodoPagamento=document.getElementById('metodoPagamento').value;
                const valorPago=parseFloat(document.getElementById('valorPago').value)||0;
                const total=parseFloat(document.getElementById('totalCarrinho').textContent);
                if (metodoPagamento==='Dinheiro' && valorPago<total){alert('Valor pago insuficiente!');return;}
                const dadosVenda={cliente_id:clienteSelect.value?parseInt(clienteSelect.value):null,itens:carrinho.map(item=>({id:item.id,qtd:item.quantidade,preco:item.preco})),total:total,forma_pagamento:metodoPagamento,valor_pago:metodoPagamento==='Dinheiro'?valorPago:total,troco:metodoPagamento==='Dinheiro'?Math.max(0,valorPago-total):0};
        
                // Segunda correção: Adicionando 'credentials' para autenticar a finalização da venda
                fetch('/caixa/finalizar', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(dadosVenda),
                    credentials: 'same-origin' // <-- CORREÇÃO 2 AQUI
                })
                .then(resp => {
                    if (!resp.ok) {
                         // Se a resposta não for OK, tenta ler o erro do corpo da resposta
                         return resp.json().then(err => Promise.reject(err));
                    }
                    return resp.json();
                })
                .then(data => {
                    // Supondo que seu backend envie { mensagem: '...' } em caso de sucesso
                    alert(data.mensagem || 'Venda finalizada com sucesso!');
                    carrinho = [];
                    atualizarCarrinho();
                    document.getElementById('clienteSelect').value = '';
                    $('#clienteSelect').val(null).trigger('change'); // Limpa o select2
                    document.getElementById('metodoPagamento').value = 'Dinheiro';
                    toggleTroco();
                })
                .catch(err => {
                    console.error('Erro ao finalizar venda:', err);
                    // Mostra o erro específico que veio do backend, se houver
                    alert('Erro ao finalizar venda: ' + (err.erro || 'Erro desconhecido.'));
                });
            }
        </script>
    </script>
</body>
</html>
